---
title: | 
       | 異なる沿岸生態系における
       | 生態系純一次生産量の季節変動
author: "河手梓"
date: "2019"
header-includes:
  - \usepackage{booktabs}
  - \usepackage{longtable}
  - \usepackage{pdflscape}
  - \usepackage{float}
  - \usepackage[section]{placeins}
  - \newcommand{\blandscape}{\begin{landscape}}
  - \newcommand{\elandscape}{\end{landscape}}  
output: 
  bookdown::pdf_document2:
    latex_engine: xelatex
    dev: cairo_pdf
    keep_tex: yes
    citation_package: biblatex
    toc: true
    toc_depth: 3
    includes:
      in-header: force-figure-position.tex
documentclass: bxjsarticle
classoption: "xelatex, ja=standard"
fig_crop: yes
fig_caption: yes
lot: yes
lof: yes
fontsize: 10pt
geometry: a4paper
link-citations: true
bibliography: 
mainfont: "Noto Serif"
sansfont: "Noto Sans"
monofont: "Source Code Pro"
CJKmainfont: "Noto Serif CJK JP"
CJKsansfont: "Noto Sans CJK JP"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = TRUE,
                      echo = FALSE,
                      fig.width =  2*80/25.4,
                      fig.height = 2*80/25.4,
                      out.width = "80%", 
                      out.height = "70%",
                      fig.align = "center", 
                      warning = FALSE, 
                      message=FALSE,
                      error = FALSE, 
                      autodep = TRUE)
options(knitr.kable.NA = '', texi2dvi = "xetex")
options(kableExtra.latex.load_packages = FALSE, tidyverse.quiet = TRUE)
Sys.setlocale("LC_TIME", "en_US.UTF-8") # アメリカ英語に設定
```

```{r, cache = FALSE}
library(tidyverse)
library(lubridate)
library(readxl)
library(knitr)
library(kableExtra)
library(stringr)
library(glue)
library(grid)
library(lemon)
#マイ関数------------------------------
my_date_format = function() {
  # 年・月の軸のフォーマットを定義
  function(x)
  {
    m <- format(x,"%m")
    y <- format(x,"%Y")
    ifelse(duplicated(y),
           paste0(m,"月"),
           paste0(m,"月\n", y, "年"))
  }
}

month_labels = function() {
  function(x) {
    paste0(x, "月")
  }
}
source("../theme_kawate.R")
```

```{r, eval = FALSE}
# docx ファイルを markdown 形式に変換するとき，pandoc を使う。
# pandoc は linux ターミナルから実行しないといけない。
# ls コマンドはファイルの閲覧
# cd がフォルダーの移動
# cd soturon_text_google_drive
# pandoc -s 異なる沿岸生態系における生態系純一次生産量の季節変動.docx -o thesis.md
```

# 諸言

近年，社会問題となっている地球温暖化の主な原因は，人間活動によって放出される温室効果ガスの増加である。
大気中の二酸化炭素濃度が上昇したことだと言われている( IPCC 2007 )。
そのことから，炭素固定が注目されている。
大気中に放出される炭素は，年間約 72 億トンと言われている。そのうちの 13 % は陸上生態系に固定され， 30 % は海洋に固定される。
残りの 57 % は大気中に残る。海洋に固定される炭素の10 % は沿岸生態系によって固定される ( IPCC 2007 )。
このことから，沿岸域は炭素固定における重要な役割を担っていると言える。生態系による炭素収支は生態系純一次生産量 ( Net Ecosystem Production; NEP ) で表すことができる（ Chapin *et al*. 2018 ）。
沿岸生態系における NEPの推定は，バイオマス法を多く用いられてきた。
バイオマス法は，生態系を構成する生物の成長からNEP を推定する方法である。
この方法は藻体の生長を直接計測して NEP の推定を行う。
しかし，バイオマス法にはいくつかの欠点がある。
一つは，バイオマス法を用いる際に一定量の刈り取りが必要であることだ。
刈り取りを繰り返すことで，その生態系の破壊につながりかねない。
また，対象の生物の成長を待つ必要があり，短い期間での測定は難しいことである。
沿岸域の環境は短い期間でも大きく変動する ( Pérez-Ruzafa *et al*. 2007 )。
その影響は NEP にも表れていると考えられる。
そのため，短い測定間隔での観測が必要である。
さらに，生態系にはプランクトンや，生息する魚類なども含まれている。
バイオマス法では，海藻や海草などその生態系を構成する生物の成長しかみることができない。
そのため，NEP ではなく，純一次生産量 ( Net Primary Production; NPP )を測定していることになる。 
NEPを推定するためには，生態系に生息する全ての生物を考慮する必要がある。

そこで，より正確に NEP を推定するためには開放系溶存酸素法 ( Odum 1965 ) を用いる必要があると考えられた。
開放系溶存酸素法は生態系の溶存酸素濃度の変動から呼吸量や生産量を推定する方法である。
そのため，生態系に影響を与えることなく，生態系に生息する生物全体を考慮することができる。
さらに，測定間隔の自由度が高く，短い間隔での測定が可能である ( Staehr *et al*., 2012 )。
そのため，より正確に NEP を推定することができる。本研究では，この開放系溶存酸素法を用いて研究を進めた。

陸上生態系では，生態系ごとに NEP の季節変動が異なることが知られている。
Xiao *et al*. ( 2008 ) は，落葉広葉樹林とバイオマスが小さい灌木地における NEP の季節変動を調査した。
落葉広葉樹林は季節変動が大きかった。
一方で，灌木地では季節変動は緩やかであった。
このように陸上生態系では，生態系によってNEP の季節変動が異なることが知られている。
沿岸生態系は藻場，磯焼け域，サンゴ礁，マングローブ林など様々な生態系があるため，陸上生態系のように生態系ごとに NEP の季節変動は変わると考えた。
沿岸生態系における季節変動を，開放系溶存酸素法を用いて研究した例はいくつかある。
しかし，その多くがアマモ場 ( Welsh *et al*. 2000 ; Murrell *et al.* )を対象とした研究であり，異なる生態系の NEP の季節変動を比べた研究は非常に少ない。

そこで本研究は，沿岸域の代表的な生態系として，高い生産性をもつ藻場生態系と，藻場が消失した磯焼け生態系に着目し，開放系溶存酸素法を用いて，NEPの季節変動を明らかにすることを目的とした。
そして，本研究において，バイオマスの大きい藻場生態系の NEP はバイオマスが小さい磯焼け生態系より高いと仮説を立てた。

# 方法

## 調査地


本調査は，長崎県五島列島の中通島に位置する新上五島町有川地先と鯛ノ浦湾 (図\@ref(fig:kamigoto-map))にて行った。
有川地先では褐藻類によってガラモ場が形成されていた。
一方，鯛ノ浦湾では磯焼け生態系が広がっていた。

## 使用した観測機器

本調査は，溶存酸素ロガー ( HOBO U26 溶存酸素ロガー，Onset Computer Corporation ) を用いて，溶存酸素濃度 ( mg O~2~L^-1^ ) と水温 ( °C ) ，光量子ロガー ( Odyssey Submersible PAR Logger, Dataflow Systems Ltd. ) を用いて光量子量 ( µmol s^-1^ ) の観測を行った。
各ロガーのサンプリングインターバルは，10 分に統一した。
観測した溶存酸素ロガーは，データ回収時に，CTD を用いて測定した海水塩濃度を用いて塩分補正を行い，光学式溶存酸素メーター ( ProODO, YSI, Inc. ) によってキャリブレーションを行った。
光量子量は，LI-190 ( Quantum Sensor, Li-Cor, Inc.) を基準とし補正値を算出し，補正を行った。

## 観測方法

海底から 0 m と 1 m 観測帯で溶存酸素濃度，水温を，海底から 0.5 m 観測帯で光量子量の観測を行った（図\@ref(fig:setup-image)）。
溶存酸素ロガーは，ロープの両端にアンカーとブイをくくり付け，中層ブイの浮力によって藻場内に張ったロープに，それぞれの観測帯にセンサーが来るようにカラビナ，結束バンド，ビニールテープを用いて 1 本ずつ取り付け，それぞれの藻場に設置した。
光量子ロガーは，ロープの端に輪切りにしたホースと結束バンドを用いて光量子ロガーを固定したものを，別のロープの両端にウエイトをつけて海底に張ったロープに取り付け，光量子ロガーの浮力を利用して，海中で自立できるようにした。
それぞれの観測帯にセンサーが来るようにロープの長さを調節し，それぞれの藻場に設置した。
また，光量子ロガーの浮力が不足している場合には，光量子ロガーを取り付けたホースに気泡緩衝材を巻くことで，浮力を追加した。

観測機材の設置はシュノーケリングによって行い，藻場内に設置する機材は，藻場を目視することによって海藻，海草が倒れないよう藻場の中に慎重に設置した。

月に 1 回，ロガーからデータを回収するとともに，ロガーに着いた付着物を取り除く・電池を交換するなどのメンテナンスを行った。
データの回収とメンテナンスを行った後，各ロガーの設定を行い，再設置した。

## 解析方法

NEP の算出には，統計解析ソフト R version 3.5.2 ( R Development Core Team 2018 ) を使用した。
得られた溶存酸素量のデータに正規分布に従う一般化加法モデル ( Generalized Additive Model ) をあてはめた，リンク関数を恒等関数とした。
GAM の接線の傾きをその時間の生産量とし， 1 日の生産量を積算したものをその日の NEP とした（式 1）。

\begin{equation}
\text{NEP} = \sum_{i}^{24}\left(\frac{dC}{dT}\right)
\end{equation}

また，夜間は光合成が行われず，呼吸のみが行われるため，夜間の生産量を生態系呼吸量とし， 1 時間あたりの 生態系呼吸量 (Ecosystem Respiration; ER) を算出した（式 2）。

\begin{equation}
\text{ER} = \sum_{T_\text{night}} \left(\frac{dC}{dT}\right)\times \frac{24}{T_\text{night}}
\end{equation}

昼と夜の区別は光量子量を基準にした。
光量子量が 0 の時を夜，それ以外を昼とした。
昼間も夜間と同じ ER であると仮定し， 1 日あたりの ER を算出した。

# 結果

それぞれの生産量の季節変動は，データを月ごとに分け，それぞれの月の生産量として結果に示した。
それぞれのグラフは線グラフ又は箱ひげ図で表し，ポイントおよび箱の中のポイントは平均値，箱の中央の横線は中央値，箱の下の横線は第一四分位数，箱の上の横線は第三四分位数，箱の下に伸びる縦線の端が最小値，箱の上に伸びる縦線の端が最大値を示している。
さらに， GAM （表\@ref(fig:gam-table) ￥を参考に）によって曲線をあてはめた。曲線の網掛け部分は 95 % 信頼区間である。

## 水温

```{r oxx}
oxygen = read_csv("~/Lab_Data/kawatea/Modified_Data/kamigoto_oxygen_all.csv")
temperature_a = 
  oxygen %>% 
  unnest() %>% 
  select(Date, location, position, datetime, temperature) %>% 
  filter(str_detect(position,"0m"))
  
#重複しているデータを削除する
temperature_a = 
  temperature_a %>% group_by(location, Date) %>% nest() %>% 
  mutate(data = map(data, function(X) {
    X %>% distinct()
  })) %>% unnest() 

#おかしな値を削除
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-04-19") & str_detect(location, "arikawagaramo")))
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-04-19") & str_detect(location, "tainoura")))
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-05-16") & str_detect(location, "tainoura")))
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-05-17") & str_detect(location, "tainoura")))
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-06-21") & str_detect(location, "tainoura")))
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-06-21") & str_detect(location, "arikawaamamo")))
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-06-21") & str_detect(location, "arikawagaramo")))
temperature_a = temperature_a %>% filter(!(Date == as.Date("2018-07-05") & str_detect(location, "tainoura")))

#月ごと
temperature = temperature_a %>% 
  mutate(month = month(Date)) 

temperature = temperature %>% 
  ungroup() %>%
  mutate(location = recode(location,
                           "tainoura" = 1,
                           "arikawaamamo" = 2,
                           "arikawagaramo" = 3,
                           "mushima2" = 4,
                           "mushima3" = 5))  %>%
  mutate(location = factor(location,
                           levels = c(1,2,3,4,5),
                           label = c("Tainoura",
                                     "Arikawa (Zostera)",
                                     "Arikawa",
                                     "Mushima (Old port)" ,
                                     "Mushima (New port)" ))) %>% 
  group_by(location, Date) %>% 
  summarise(temperature = mean(temperature, na.rm=T)) %>% 
  mutate(month = month(Date)) 

temperature = temperature %>% 
  filter(!str_detect(location, "Zostera"))

xlabel = ""
ylabel = expression(Temperature~(degree*C))
gtitle = ""

temperature_plot = 
  temperature %>%
  mutate(month = month(Date)) %>% 
  ggplot() +
  geom_boxplot(aes(x = month,
                   y = temperature,
                   color = location,
                   fill = location,
                   group =  month),
               alpha = 0.5,
               size = rel(0.4)) +
  geom_smooth(aes(x= month, y = temperature,
                  linetype = "GAM"),
              method = "gam",
              method.args = list(family = Gamma(link = "log")),
              fill = "black",
              color = "black",
              size = rel(0.4),
              alpha = 0.25,
              formula = y ~ s(x)) +
  scale_x_continuous(xlabel, 
                     minor_breaks = 1:12,
                     breaks = c(1, 5, 8, 12),
                     labels = month.abb[c(1, 5, 8, 12)]) +
  scale_y_continuous(name = ylabel,
                     limits = c(10, 30),
                     breaks = c(10, 15, 20, 25, 30)) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  theme_kawate(16) +
  facet_wrap("location", nrow = 1)

temperature2 = 
  temperature %>% 
  group_by(location, month) %>% 
  summarise_at(vars(temperature), funs(mean, sd, min, max)) %>% 
  arrange(location, month)
```

水温は 1 日ごとに平均水温を算出した。
有川地先の平均水温は 2 月に最小値 `r temperature2 %>% filter(str_detect(location, "Arik"), month == 2) %>% pull(mean) %>% round(digits = 1)` °C を記録し，7 月にかけて上昇し，最大値 `r temperature2 %>% filter(str_detect(location, "Arik"), month == 7) %>% pull(mean) %>% round(digits = 1)` °C を記録した。
また， 8 月から 12 月にかけて減少した。
鯛ノ浦湾は 2 月に最小値 `r temperature2 %>% filter(str_detect(location, "Tain"), month == 2) %>% pull(mean) %>% round(digits = 1)` °Cを記録し，8 月にかけて上昇し最大値 `r temperature2 %>% filter(str_detect(location, "Tain"), month == 8) %>% pull(mean) %>% round(digits = 1)` °Cを記録した。
8 月から 12 月にかけて減少した（表\@ref(tab:temperature-table); 図\@ref(fig:temperature-plot)）。

両地点とも，冬から夏に上昇し，夏から冬に減少する変動が見られた。

## 光量子量

```{r}
light = read_csv("../Modified_data/light_calibrate.csv")

light = light %>% 
  group_by(location, Date) %>% 
  mutate(ppfd = ifelse(ppfd < 0, 0, ppfd)) %>% 
  summarise(ppfd = sum(ppfd*60) * 10e-6) %>% 
  mutate(month = month(Date)) 

 light = 
  light %>% 
  ungroup() %>% 
  mutate(location = recode(location,
                           "tainoura" = 1, 
                           "arikawaamamo" = 2,
                           "arikawagaramo" = 3,
                           "mushima2" = 4,
                           "mushima3" = 5)) %>% 
  mutate(location = factor(location, 
                           levels = c(1,2,3,4,5),
                           label = c("Tainoura",
                                     "Arikawa (Zostera)",
                                     "Arikawa",
                                     "Mushima (Old port)" ,
                                     "Mushima (New port)" ))) 


dset_daily =light %>%  
  filter(!str_detect(location, "Zostera|Mushima")) 

xlabel = ""
ylabel = expression("Daily underwater PPFD"~(mol~m^{-2}~day^{-1}))

light_plot = 
  dset_daily %>% 
  mutate(month = month(Date)) %>% 
  ggplot()+
  geom_boxplot(aes(x = month,
                   y = ppfd,
                   color = location,
                   fill = location,
                   group =  month),
               alpha = 0.5,
               size = rel(0.4)) +
  geom_smooth(aes(x= month, y = ppfd,
                  linetype = "GAM"),
              method = "gam",
              method.args = list(family = Gamma(link = "log")),
              fill = "black",
              color = "black",
              size = rel(0.4),
              alpha = 0.25,
              formula = y ~ s(x)) +
  scale_x_continuous(xlabel, 
                     minor_breaks = 1:12,
                     breaks = c(1, 5, 8, 12),
                     labels = month.abb[c(1, 5, 8, 12)]) +
  scale_y_continuous(name = ylabel) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  theme_kawate(16) +
  facet_wrap("location", nrow = 1)

light2 =
  dset_daily %>% 
  group_by(location, month) %>% 
  summarise_at(vars(ppfd), funs(mean, sd, min, max)) %>% 
  arrange(location, month)

```


光量子量データは，1 日ごとに積算し，縦軸は 1 日あたりの積算光量子量で示した。
両地点とも，1 月から 4 月にかけて上昇し，7 月から 12 月にかけて減少する傾向が見られた（表\@ref(tab:light-table); 図\@ref(fig:light-plot)）。
また，4 月と 7 月に高くることを観測した。
有川地先の平均日積算光量子量は，4 月に `r light2 %>% filter(str_detect(location, "Arik"), month == 4) %>% pull(mean) %>% round(digits = 1)` mol day^-1^  ，7 月に `r light2 %>% filter(str_detect(location, "Arik"), month == 7) %>% pull(mean) %>% round(digits = 1)` mol day~-1~  となり，12 月に最小値 `r light2 %>% filter(str_detect(location, "Arik"), month == 12) %>% pull(mean) %>% round(digits = 1)`  mol day~-1~ を記録した。
鯛ノ浦湾の平均日積算光量子量は，4 月に `r light2 %>% filter(str_detect(location, "Tainoura"), month == 4) %>% pull(mean) %>% round(digits = 1)` mol day~-1~  ，7 月に `r temperature2 %>% filter(str_detect(location, "Tainoura"), month == 7) %>% pull(mean) %>% round(digits = 1)`  mol day~-1~ となり，2 月に最小値 `r light2 %>% filter(str_detect(location, "Tainoura"), month == 2) %>% pull(mean) %>% round(digits = 1)`  mol day~-1~ を記録した。
1 年間を通して，有川地先の方が鯛ノ浦湾より，光量子量が高くなった。

## 生態系純一次生産量 (NEP)
```{r}
df1 = read_csv("../Modified_data/kamigoto_production.csv")
light = read_csv("../Modified_data/light_calibrate.csv")
df1 = 
  df1 %>% 
  ungroup() %>% 
  mutate(location = recode(location,
                           "Tainoura (Isoyake)" = 1, 
                           "Arikawa (Zostera)" = 2,
                           "Arikawa (Sargassum)" = 3)) %>% 
  mutate(location = factor(location, 
                           levels = c(1,2,3),
                           label = c("Tainoura",
                                     "Arikawa (Zostera)",
                                     "Arikawa"))) 

df1 = df1 %>% filter(!str_detect(location, "Zostera")) 
df1 = df1 %>% mutate(location = factor(location)) # 外した要因のレベルも外す

df1 = df1 %>% spread(position, value) %>% 
  mutate(value = `1m`+`0m`)

light = light %>% group_by(location, Date) %>% summarise(ppfd = 60*sum(ppfd)/10^6) %>% 
  ungroup() %>% 
  filter(str_detect(location, "tainoura|arikawa")) %>% 
  mutate(location = recode(location,
                           "tainoura" = 1, 
                           "arikawaamamo" = 2,
                           "arikawagaramo" = 3)) %>% 
  mutate(location = factor(location, 
                           levels = c(1,2,3),
                           label = c("Tainoura",
                                     "Arikawa (Zostera)",
                                     "Arikawa"))) 

df2 = full_join(df1 %>% filter(str_detect(key, "NEP")) %>% drop_na() %>% 
                  select(Date, location, value),
                light, by = c("Date", "location") ) %>% 
  filter(str_detect(location, "Tainoura|Sarg"))

#NEP-----------------------------------------------
xlabel = ""
ylabel = expression("NEP"~(g~O[2]~m^{-2}~day^{-1}))
gtitle = ""

dset03 = 
  df1  %>% 
  filter(str_detect("NEP", key))

NEP_plot = 
dset03 %>% 
  ggplot(aes(x = month,
             y = value, 
             color = location,
             fill = location)) +
  geom_boxplot(aes(group = month), 
               alpha = 0.5,
               size = rel(0.2)) +
  geom_smooth(aes(linetype = "GAM"),
              color = "black", fill = "black",
              method = "gam", 
              size = rel(0.4),
              alpha = 0.25,
              formula = y ~ s(x, bs = "cc"))  + 
  scale_x_continuous(xlabel, 
                     minor_breaks = 1:12,
                     breaks = c(1, 5, 8, 12),
                     labels = month.abb[c(1, 5, 8, 12)]) +
  scale_y_continuous(ylabel) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  # facet_rep_wrap("location", nrow = 1)+
  facet_wrap("location", nrow = 1)+
  theme_kawate(base_size = 16) 

NEP2 =
  dset03 %>% 
  group_by(location, month) %>% 
  drop_na() %>% 
  summarise_at(vars(value), funs(mean, sd, min, max)) %>% 
  arrange(location, month)
```

有川地先の平均 NEP は 1 月から 4 月にかけて上昇し，最大値 `r NEP2 %>% filter(str_detect(location, "Arik"), month == 4) %>% pull(mean) %>% round(digits = 1)` mg O~2~m~-2~ day~-1~ を記録した。
6 月， 7 月にかけて減少したが，8 月に上昇し， `r NEP2 %>% filter(str_detect(location, "Arik"), month == 8) %>% pull(mean) %>% round(digits = 1)` mg O~2~ m~-2~ day~-1~ を記録した。
その後，12 月にかけて減少し，最小値  `r NEP2 %>% filter(str_detect(location, "Arik"), month == 12) %>% pull(mean) %>% round(digits = 1)` mg O~2~ m~-2~ day~-1~ を記録した。
鯛ノ浦湾は 1 月に最小値  `r NEP2 %>% filter(str_detect(location, "Tainoura"), month == 1) %>% pull(mean) %>% round(digits = 1)`mg O~2~ m~-2~ day~-1~ を記録した後，5 月にかけて上昇し最大値  `r NEP2 %>% filter(str_detect(location, "Tainoura"), month == 5) %>% pull(mean) %>% round(digits = 1)` mg O~2~ m~-2~ day~-1~ を記録した。
6 月，7 月にかけて減少したが，8 月に上昇し， `r NEP2 %>% filter(str_detect(location, "Tainoura"), month == 8) %>% pull(mean) %>% round(digits = 1)` mg O~2~m~-2~ day~-1~ を記録した。
その後，12 月にかけて減少した（表\@ref(tab:NEP-table); 図\@ref(fig:NEP-plot)）。

両藻場とも，生産量が 1 年を通して正の値となった。
また，鯛ノ浦湾は，有川地先に比べて NEP の季節変動を緩やかであった。

# 考察

## 2 地点における NEP の季節変動

1 年を通して，有川地先の方が鯛ノ浦湾に比べて NEP が高くなった（表\@ref(tab:NEP-table); 図\@ref(fig:NEP-plot)））。
これは，光量子量が 1 年を通して，有川地先の方が高かった（図）ためであると考えられる。
一般的に光量子量が高くなることで，海藻の NEP が高くなることが知られている ( 村瀬 2001 ; Terada *et al*. 2013 ) 。
そのため，光量子量が高い有川地先では，鯛ノ浦湾に比べて光合成が活発であったと考えられる。

また， NEP の季節変動は有川地先の方が大きかった。
これは，生態系の状態が異なるためだと考えられる。
有川地先は，生産性の高い藻場生態系であるのに対し，鯛ノ浦は藻場が消失した磯焼け生態系である。
この違いが NEP の変動に表れたと考えられる。
これは，陸上生態系における，バイオマスが小さい灌木地の NEP の季節変動が，バイオマスが大きい落葉広葉樹林に比べて緩やかであること ( Xiao *et al*. 2008 ) と傾向が一致した。

## 4, 8 月の NEP
```{r}
# RP の引用のため，作図
df1 = read_csv("../Modified_data/kamigoto_production.csv")
light = read_csv("../Modified_data/light_calibrate.csv")
df1 = 
  df1 %>% 
  ungroup() %>% 
  mutate(location = recode(location,
                           "Tainoura (Isoyake)" = 1, 
                           "Arikawa (Zostera)" = 2,
                           "Arikawa (Sargassum)" = 3)) %>% 
  mutate(location = factor(location, 
                           levels = c(1,2,3),
                           label = c("Tainoura",
                                     "Arikawa (Zostera)",
                                     "Arikawa"))) 

df1 = df1 %>% filter(!str_detect(location, "Zostera")) 
df1 = df1 %>% mutate(location = factor(location)) # 外した要因のレベルも外す

df1 = df1 %>% spread(position, value) %>% 
  mutate(value = `1m`+`0m`)

light = light %>% group_by(location, Date) %>% summarise(ppfd = 60*sum(ppfd)/10^6) %>% 
  ungroup() %>% 
  filter(str_detect(location, "tainoura|arikawa")) %>% 
  mutate(location = recode(location,
                           "tainoura" = 1, 
                           "arikawaamamo" = 2,
                           "arikawagaramo" = 3)) %>% 
  mutate(location = factor(location, 
                           levels = c(1,2,3),
                           label = c("Tainoura",
                                     "Arikawa (Zostera)",
                                     "Arikawa"))) 

df2 = full_join(df1 %>% filter(str_detect(key, "NEP")) %>% drop_na() %>% 
                  dplyr::select(Date, location, value),
                light, by = c("Date", "location") ) %>% 
  filter(str_detect(location, "Tainoura|Sarg"))

xlabel = ""
ylabel = expression("ER"~(g~O[2]~m^{-2}~day^{-1}))
gtitle = "Respiration Production"

dset02 = 
  df1  %>% 
  filter(str_detect("RP", key)) %>% 
  # spread(position, value) %>% 
  mutate(value = `1m`+`0m`)

RP_plot = 
dset02 %>% 
  ggplot(aes(x = month,
             y = value, 
             color = location,
             fill = location)) +
  geom_boxplot(aes(group = month), 
               alpha = 0.5,
               size = rel(0.2)) +
  geom_smooth(aes(linetype = "GAM"),
              color = "black", fill = "black",
              method = "gam", 
              size = rel(0.4),
              alpha = 0.25,
              formula = y ~ s(x, bs = "cc"))  + 
  scale_x_continuous(xlabel, 
                     minor_breaks = 1:12,
                     breaks = c(1, 5, 8, 12),
                     labels = month.abb[c(1, 5, 8, 12)]) +
  scale_y_continuous(ylabel) +
  scale_color_brewer(palette = "Dark2") +
  scale_fill_brewer(palette = "Dark2") +
  # facet_rep_wrap("location", nrow = 1)+
  facet_wrap("location", nrow = 1)+
  theme_kawate(base_size = 16) 

RP2 =
  dset02 %>% 
  group_by(location, month) %>% 
  drop_na() %>% 
  summarise_at(vars(value), funs(mean, sd, min, max)) %>% 
  arrange(location, month)
```

両地点において， NEP は 4 月と 8 月に高くなった（表\@ref(tab:NEP-table); 図\@ref(fig:NEP-plot)）。
4 月に NEP が高くなった要因は高い光量子量と水温が 20 ℃ であったことが関係していると考えられる。
土屋ら ( 2012 ) は，褐藻に属するホンダワラ類の純一次生産量 ( Net Primary Production ; NPP ) が水温 20 ℃ のとき，高くなることを明らかにしている。
このことからも，4 月に NEP が高くなる要因として，水温が関係していると考えられた。
また， 8 月に NEP が高くなる要因は高い光量子量と高い水温であると考えられる。
8 月の NEP は 4 月に比べて低い値を示した。
この原因は，水温上昇による ER の上昇であると考えられた。
しかし，本研究で記録した ER は 8 月よりも 4 月の方が高くなった（表\@ref(tab:RP-table); 図\@ref(fig:RP-plot)）。
このことから， ER の上昇が原因とは言えなかった。
土屋ら ( 2012 ) は，水温が上昇することで， NPP が減少することを明らかにした。
このことから， 8 月の NEP は，水温が上昇したことで，抑えられたのだと考えられる。

## 6, 7 月の NEP

```{r}
#　流速（引用のため作図）
#エクセルファイルの時間データ処理用
fix_xlsx_date = function(x) {
  as.character(glue("{sprintf('%02d', day(x))}/{sprintf('%02d', month(x))}/{year(x)}"))
}
fix_xlsx_time = function(x) {
  as.character(glue("{sprintf('%02d', hour(x))}:{sprintf('%02d', minute(x))}:{sprintf('%02d', second(x))}"))
}

fnames = dir("~/Lab_Data/kawatea/CEM/", full = TRUE)

#CEM-------------------------------------------------------------
#読み込み
col_type = "nccnnnnnnnnnnnnnnnnn_"
cem_file = tibble(file = fnames)
cem = cem_file %>% 
  mutate(cem = map(file, read_csv, skip = 36, 
                   locale = locale(encoding = "CP932"),
                   col_type = col_type))

cem =
  cem %>% 
  mutate(file = basename(file)) %>% 
  separate(file, c("x", "y", "location", "position", "z")) %>% 
  unnest() %>% 
  mutate(datetime = ymd_hms(paste(`YYYY/MM/DD`, `hh:mm:ss`))) %>% 
  dplyr::select(location, datetime,
         speed = starts_with("Velo["),
         velX = starts_with("Vel X["),
         velY = starts_with("Vel Y["),
         temperature = starts_with("Temp[")) %>% 
  filter(between(velX, -250, 250)) %>% 
  filter(between(velY, -250, 250))


kikan = read_xlsx("~/Lab_Data/kawatea/調査機関.xlsx")
kikan = kikan %>% filter(str_detect(location, "garamo|tainoura")) 
kikan = kikan %>% mutate(start_date = start_date + days(2))    

cem = full_join(kikan %>% unnest() %>% group_by(location) %>% nest(),
                cem %>% group_by(location) %>% nest(),
                by = "location")

# 期間範囲毎のフィルター (data.table パッケージのinrange()を使う)
cem = 
  cem %>% 
  mutate(data = map2(data.x, data.y, function(X, Y) {
    Y %>% filter(data.table::inrange(datetime, X$start_date, X$end_date)) %>% 
      mutate(H = hour(datetime) + minute(datetime) / 60) %>% 
      mutate(Date = as.Date(datetime))
  }))


cem = 
  cem %>% unnest(data) %>% 
  mutate(datetime2 = floor_date(datetime, unit = "minutes")) %>% 
  group_by(location, datetime2) %>% 
  summarise(mean_speed = mean(speed),
            sd_speed = sd(speed))

cem = cem %>% rename(datetime = datetime2)
cem = cem %>% mutate(Date = as.Date(datetime))

#おかしなデータ削除
cem = cem %>% filter(!(Date == as.Date("2017-11-18") & str_detect(location, "tainoura")))
cem = cem %>% filter(!(Date == as.Date("2017-10-31") & str_detect(location, "tainoura")))
cem = cem %>% filter(!(Date == as.Date("2018-03-19") & str_detect(location, "arikawagaramo")))
cem = cem %>% filter(!(Date == as.Date("2018-03-20") & str_detect(location, "arikawagaramo")))
cem = cem %>% filter(!(Date == as.Date("2018-03-21") & str_detect(location, "arikawagaramo")))
cem = cem %>% filter(!(Date == as.Date("2018-03-05") & str_detect(location, "arikawagaramo")))
cem = cem %>% filter(!(Date == as.Date("2018-03-16") & str_detect(location, "arikawagaramo")))
cem = cem %>% filter(!(Date == as.Date("2018-03-17") & str_detect(location, "arikawagaramo")))

#月ごとにグループ化できるようにする
cem = cem %>% 
  mutate(month = month(Date))

cem = 
  cem %>% 
  ungroup() %>% 
  mutate(location = recode(location,
                           "tainoura" = 1, 
                           "arikawagaramo" = 2)) %>% 
  mutate(location = factor(location, 
                           levels = c(1,2),
                           label = c("Tainoura",
                                     "Arikawa")))


#作図
xlabel = ""
ylabel = expression("Velocity"~(cm~sec^{-1}))
gtitle = ""

cem_plot = 
cem %>% 
  group_by(location,month) %>% 
  drop_na() %>% 
  summarise(speed_mean = mean(mean_speed),
            sd_speed = sd(mean_speed),
            n = sum(!is.na(mean_speed))) %>% 
  mutate(l95 = speed_mean - sd_speed / sqrt(n -1),
         u95 = speed_mean + sd_speed / sqrt(n -1)) %>%
  ggplot(aes(x = month, y = speed_mean, color = location))+
  geom_point(position=position_dodge(0.1)) +
  geom_line( position=position_dodge(0.1)) +
  geom_errorbar(aes(ymin = l95, ymax = u95), width = 0,
                position = position_dodge(0.1)) +
  scale_x_continuous(name = xlabel,
                     labels = month_labels(),
                     breaks = 1:12,
                     limits = c(1,12)) +
  scale_y_continuous(name = ylabel,
                     limits = c(0, 8),
                     breaks = c(0, 2, 4, 6, 8)) +
  scale_color_brewer(name = "", palette = "Dark2") +
  ggtitle(gtitle) +
    theme_kawate(base_size = 16) 

cem2 =
  cem %>% 
  group_by(location, month) %>% 
  drop_na() %>% 
  summarise_at(vars(mean_speed), funs(mean, sd, min, max)) %>% 
  arrange(location, month)

```

```{r}
nutrient2017 = tibble(fname = dir("~/Lab_Data/nutrient/2017Data/", full = TRUE))
nutrient2018 = tibble(fname = dir("~/Lab_Data/nutrient/2018Data/", full = TRUE))

nutrient2017 = nutrient2017 %>% mutate(data = map(fname, read_csv))
nutrient2018 = nutrient2018 %>% mutate(data = map(fname, read_csv))

nutrient2017 =
  nutrient2017 %>%
  mutate(data = map(data, function(X) {
    X %>%
      mutate(location = recode(location,
                               `有川湾 (ガラモ場)` = "Arikawa.Sargassum",
                               `有川湾 (アマモ場)` = "Arikawa.Zostera",
                               `鯛ノ浦湾` = "Tainoura.Isoyake",
                               `六島旧港` = "Mushima.St2",
                               `六島新港` = "Mushima.St3",
                               `焼崎` = "Yakizaki.Isoyake")) %>%
      mutate(sampling_depth = recode(position,
                                     `低層` = "Bottom",
                                     `表層` = "Surface",
                                     `中層` = "Middle")) %>%
      mutate(Nutrient = recode(parameter,
                               `NO[2]` = "NO2",
                               `NO[3]` = "NO3",
                               `PO[4]` = "PO4",
                               `NH[4]` = "NH4")) %>%
      dplyr::select(date, location, sampling_depth, Nutrient, conc = mumol_mean) %>%
      separate(location, into = c("station", "variable")) %>%
      filter(!str_detect(Nutrient, "Si*"))
  })) %>% unnest(data) %>% select(-fname)

nutrient2017 =
  nutrient2017 %>%
  group_by(Nutrient, station, variable, sampling_depth) %>%
  nest() %>%
  spread(Nutrient, data) %>%
  mutate(NO2_NO3 = map2(NO2, NO3, function(X, Y) {
    x = X %>% pull(conc)
    y = Y %>% pull(conc)
    z = X %>% pull(date)
    tibble(date = z, conc = x + y)
  })) %>%
  dplyr::select(-NO2, -NO3) %>%
  gather(Nutrient, data, -(station:sampling_depth)) %>%
  unnest(data) 

nutrient2018 =
  nutrient2018 %>%
  mutate(n = 1:3) %>%
  mutate(data = map2(data, n, function(X, Y) {
    if(Y == 1) {
      X
    } else {
      X %>% select(ID:Nutrient, conc = conc_base_gain_carry_value)
    }
  })) %>%
  unnest() %>%
  dplyr::select(date, station, variable, sampling_depth, Nutrient, conc)

nutrient =
  bind_rows(nutrient2017, nutrient2018) %>%
  filter(str_detect(sampling_depth, "Bottom|Middle|Surface$")) %>%
  filter(str_detect(Nutrient, "PO4|NO2_NO3"))

# 月々の平均 ----
xlabel = ""
ylabel = expression("Mean concentration"~(mu*mol~L^{-1}))
gtitle = ""

nutrient_plot = 
nutrient %>%
  mutate(conc = ifelse(conc < 0, 0, conc),
         month = month(date)) %>%
  group_by(station, month, Nutrient) %>%
  summarise(conc_mean = mean(conc, na.rm=T),
            conc_sd = sd(conc, na.rm = T),
            n = sum(!is.na(conc))) %>%
  ungroup() %>%
  mutate(month_offset = factor(month, levels = c(7:12, 1:6),
                        labels = month.abb[c(7:12, 1:6)])) %>%
  mutate(l95 = conc_mean - conc_sd / sqrt(n -1),
         u95 = conc_mean + conc_sd / sqrt(n -1)) %>%
  filter(str_detect(station, "Arikawa|Tainoura")) %>%
  mutate(Nutrient = recode(Nutrient,
                           NO2_NO3 = 'NO[x]-N',
                           PO4 = 'PO[4]-P')) %>%
  ggplot(aes(x = (month),
             y = conc_mean,
             color = station)) +
  geom_point(position=position_dodge(0.1)) +
  geom_line( position=position_dodge(0.1)) +
  geom_errorbar(aes(ymin = l95, ymax = u95), width = 0,
                position = position_dodge(0.1)) +
  scale_x_continuous(name = xlabel,
                     breaks = 1:12,
                     labels = month.abb[1:12]) +
  scale_y_continuous(name = ylabel) +
  scale_color_brewer(name = "", palette = "Dark2") +
  ggtitle(gtitle) +
  facet_rep_wrap("Nutrient",
                 repeat.tick.labels = TRUE,
                 scales = "free_y",
                 ncol = 1, labeller = label_parsed) +
  theme_kawate(base_size = 16) +
  theme(legend.position = c(0.5,1),
        legend.justification = c(0.5,1))

nutrient2 =
  nutrient %>% 
  mutate(conc = ifelse(conc < 0, 0, conc),
         month = month(date)) %>% 
  group_by(station, month, Nutrient) %>% 
  drop_na() %>% 
  summarise_at(vars(conc), funs(mean, sd, min, max)) %>% 
  arrange(station, Nutrient, month)
```
両地点において， 6 月と 7 月に NEP が低くなることが記録された（表\@ref(tab:NEP-table); 図\@ref(fig:NEP-plot)）。
本研究で得られた光量子量データによると，6 月の光量子量は 4 月や 8 月に比べて低くなった（表\@ref(tab:light-table); 図\@ref(fig:light-plot)）。
光量子量が低いと，光合成速度は低下することがわかっている（ 村瀬 2001 ; Terada *et al*. 2013 ）ため， 6 月は光合成が抑制され， NEP が低下したと考えられる。
しかし， 7 月は，光量子量が 2 地点において高くなっていた（表\@ref(tab:light-table); 図\@ref(fig:light-plot)）。
このため，光量子量が原因ではないと考えられる。
その他にも，河川からの流入による撹拌や栄養塩の季節変動などが考えられた。
河川について，有川地先は，流れ込んでくる河川は存在しないため，影響はないと断言できる。
一方，鯛ノ浦には， 3 本の川が流れ込んでいる。
しかし，この川の河口域と観測地点は離れているうえ，観測地点における流速は1年を通して大きな変動はないため（図\@ref(fig:cem-plot)），影響は少ないと考えられる。
栄養塩に関しては，所属している研究室にて月に 1 回データを取っている。
栄養塩濃度は， 1 月と 12 月に高くなり，その他の期間は横ばいになる（ 図\@ref(fig:nutrient-plot)）。
NEP に高低差が生まれた 4 月， 6 月， 7 月， 8 月の栄養塩濃度に差は見られなかった。
このため，栄養塩濃度は NEP が低くなる要因とは言えない。
以上のことから， 7 月に NEP が低くなる要因は現時点では説明できなかった。

## 鯛ノ浦における NEP について

磯焼け生態系である鯛ノ浦にて， NEP が負の値をとることはなかった（表\@ref(tab:NEP-table); 図\@ref(fig:NEP-plot)）。
海藻類がほとんど消失しているにも関わらず， NEP が負の値を示すことがなかったのは，微細藻などの植物プランクトンによる生産量があったためだと考えられる( Fieled 1998 )。
そのため，鯛ノ浦湾におけるNEPを底上げしたと考えられる。
しかし，本研究の中では，海藻類による NEP とプランクトンによる NEP を分けることはできない。
そのため，植物プランクトンによる NEP の推定はできない。
今後，プランクトンによる生産量を推定することは，磯焼け生態系における NEP の変動を理解するうえで重要なことである。

# まとめ

本研究では，異なる状態の沿岸生態系において，開放系溶存酸素法を用いて NEP の観測を行った。
その結果，沿岸域において，生態系が異なることで， NEP の季節変動に違いが生まれることが明らかとなった。

本研究は，藻場生態系と磯焼け生態系を対象とし研究を進めたが，沿岸域生態系には他にも様々な植生をもつ生態系がある。
こうした生態系の NEP の季節変動を調べることでより良く沿岸生態系の NEP を理解できると考えられる。
また，植物プランクトンによる NEP やバイオマスの季節変動を追う必要がある。

# 謝辞

本研究を行うにあたり，研究計画等多くの御助言，ご指導いただきました長崎大学海洋未来イノベーション機構環東シナ海環境資源研究センター准教授Gregory　N. Nishihara　博士に深謝申し上げます。
本研究を行うにあたり調査地の提供をしてくださいました新上五島町役場　伊賀　剛氏を初め，組合の方々に厚く御礼を申し上げます。
本研究の野外調査，供試材料採集を行うにあたり，多くの御協力，ご支援を頂いた長崎大学環東シナ海環境資源研究センター日野出　賢二郎氏，井上　幸男氏，大崎　　幸一氏，紙崎　星美氏，Dominic Belleza 氏，畑田　菜緒氏，松田　悠平氏に御礼を申し上げます。

# 参考文献

Chapin, F. S., Pamela, A. M., Peter, M. V. 2018. Principles of
Terrestrial Ecosystem 　　Ecology Second Edition （加藤　知道監訳
『生態系生態学　第２版』森北出　　版 2018 年）pp 1-437.

Field, C. B., Behrenfeld, M. J., Randerson, J. T., Falkowski, P. 1998.
Primary Production of the Biosphere : Integrating Terrestrial and
Oceanic Components. Science 281:237-240.

IPCC. 2007. Climate Change 2007 : Impacts, Adaptation and
Vulnerability.Martin, P. et 　　al. Cambridge University Press,
Cambridge, pp 1-272.

Murrell, M. C., Caffrey, J. M., Marcovich, D. T., Beck, M. W., Jarvis,
B. M., Hagy, J. D.

　　2017. Seasonal Oxygen Dynamics in a Warm Temperate Estuary: Effects
of Hydrologic Variability on Measurements of Primary Production,
Respiration, and 　　Net Metabolism. *Estuaries and Coasts.*
doi:10.1007/s12237-017-0328-9.

村瀬昇 2001. 褐藻ノコギリモク Surgassum macrocarpam C.Agardh
の生態学的　　研究，水産大学校研究業績 49 (4)131 - 212.

ODUM, H. T. 1956. Primary Production in Flowing Waters. Limnology and
Oceanography. **1**(2), 102–117. doi:10.4319/lo.1956.1.2.0102.

Pérez-Ruzafa, A., Marcos, C., Pérez-Ruzafa, I. M., Barcala, E., Hegazi,
M. I., Quispe, J. 2007. Detecting changes resulting from human pressure
in a naturally quick-changing and heterogeneous environment: Spatial and
temporal scales of variability in coastal lagoons. Estuarine, Coastal
and Shelf Science. 75, 175–188. doi:10.1016/j.ecss.2007.04.030.

R Core Team 2018. R: A language and environment for statistical
computing. R Foundation for Statistical Computing,Vienna, Austria. URL
http://www.R-project.org/.

Staehr, P. A., Testa, J. M., Kemp, W. M., Cole, J. J., Sand-Jensen, K.,
& Smith, S. V. 2012. The metabolism of aquatic ecosystems: History,
applications, and future challenges. Aquatic Sciences. 74, 15–29.
doi:10.1007/s00027-011-0199-2.

Terada, R., Inoue, S., Nishihara, G. N. 2013. The effect of light and
temperature on the growth and photosynthesis of Gracilariopsis chorda
(Gracilariales, Rhodophtya) from geographically separated locations of
Japan. J Appl Phycol. 25:1863–1872.

土屋勇太朗・Gregory N. Nishihara・寺田竜太 2012.
酸素電極法とパルス変調クロロフィル蛍光法を用いた鹿児島産ホンダワラ属（ヒバマタ目）藻類５種，マメタワラ，ヤツマタモク，ヒジキ，コブクロモク，キレバモクの光合成・温度特性，日本水産学会
78(2) 189-197.

Welsh, D. T., Bartoli, M., Nizzoli., D., Giuseppe C., Stéphane A. R.,
Pierluigi V. 2000. Denitrification, nitrogen fixation, community primary
productivity and inorganic-N and oxygen fluxes in an intertidal *Zostera
noltii* meadow. Marine Ecology Progress Series. 208:65-77.

Xiao, J., Zhuang, Q., Baldocchi, D.D., Law, B.E., Richardson, A.D., et
al. 2008. Estimation of net ecosystem carbon exchange for the
conterminous United States by combining MODIS andAmeriFlux data.
agricultural and forest meteorology. 148:1827-1847.


# Figures

```{r, cache = TRUE, results="hide"}
createScaleBar <- function(lon,lat,distanceLon,distanceLat,distanceLegend, dist.units = "km"){
  bottomRight <- gcDestination(lon = lon, lat = lat, bearing = 90, dist = distanceLon, dist.units = dist.units, model = "WGS84")
  
topLeft <- gcDestination(lon = lon, lat = lat, bearing = 0, dist = distanceLat, dist.units = dist.units, model = "WGS84")
rectangle <- cbind(lon=c(lon, lon, bottomRight[1,"long"], bottomRight[1,"long"], lon),
                     lat = c(lat, topLeft[1,"lat"], topLeft[1,"lat"],lat, lat))
rectangle <- data.frame(rectangle, stringsAsFactors = FALSE)
  
# Second rectangle t right of the first rectangle
bottomRight2 <- gcDestination(lon = lon, lat = lat, bearing = 90, dist = distanceLon*2, dist.units = dist.units, model = "WGS84")
rectangle2 <- cbind(lon = c(bottomRight[1,"long"], bottomRight[1,"long"], bottomRight2[1,"long"], bottomRight2[1,"long"], bottomRight[1,"long"]),
                      lat=c(lat, topLeft[1,"lat"], topLeft[1,"lat"], lat, lat))
rectangle2 <- data.frame(rectangle2, stringsAsFactors = FALSE)
  
# Now let's deal with the text
onTop <- gcDestination(lon = lon, lat = lat, bearing = 0, dist = distanceLegend, dist.units = dist.units, model = "WGS84")
onTop2 <- onTop3 <- onTop
onTop2[1,"long"] <- bottomRight[1,"long"]
onTop3[1,"long"] <- bottomRight2[1,"long"]
  
legend <- rbind(onTop, onTop2, onTop3)
legend <- data.frame(cbind(legend, text = c(0, distanceLon, distanceLon*2)), stringsAsFactors = FALSE, row.names = NULL)
return(list(rectangle = rectangle, rectangle2 = rectangle2, legend = legend))
}

createOrientationArrow <- function(scaleBar, length, distance = 1, dist.units = "km"){
  lon <- scaleBar$rectangle2[1,1]
  lat <- scaleBar$rectangle2[1,2]
  
  # Bottom point of the arrow
  begPoint <- gcDestination(lon = lon, lat = lat, bearing = 0, dist = distance, dist.units = dist.units, model = "WGS84")
  lon <- begPoint[1,"long"]
  lat <- begPoint[1,"lat"]
  
  # Let us create the endpoint
  onTop <- gcDestination(lon = lon, lat = lat, bearing = 0, dist = length, dist.units = dist.units, model = "WGS84")
  
  leftArrow <- gcDestination(lon = onTop[1,"long"], lat = onTop[1,"lat"], bearing = 225, dist = length/5, dist.units = dist.units, model = "WGS84")
  
  rightArrow <- gcDestination(lon = onTop[1,"long"], lat = onTop[1,"lat"], bearing = 135, dist = length/5, dist.units = dist.units, model = "WGS84")
  
  res <- rbind(
    cbind(x = lon, y = lat, xend = onTop[1,"long"], yend = onTop[1,"lat"]),
    cbind(x = leftArrow[1,"long"], y = leftArrow[1,"lat"], xend = onTop[1,"long"], yend = onTop[1,"lat"]),
    cbind(x = rightArrow[1,"long"], y = rightArrow[1,"lat"], xend = onTop[1,"long"], yend = onTop[1,"lat"]))
  
  res <- as.data.frame(res, stringsAsFactors = FALSE)
  
  # Coordinates from which "N" will be plotted
  coordsN <- cbind(x = lon, y = (lat + onTop[1,"lat"])/2)
  
  return(list(res = res, coordsN = coordsN))
}

res <- c()
scaleBar <- function(lon, lat, distanceLon, distanceLat, distanceLegend, dist.unit = "km", rec.fill = "white", rec.colour = "black", rec2.fill = "black", rec2.colour = "black", legend.colour = "black", legend.size = 3, orientation = TRUE, arrow.length = 500, arrow.distance = 300, arrow.North.size = 6, arrow.color = "black", box = TRUE, box.line.color = "black", box.fill.color = "white", box.offset = 1){
  if (box){# Add a background box for better visualization on top of a base map
    topLeft <- gcDestination(lon = lon, lat = lat, bearing = 0, dist = distanceLat, dist.units = dist.unit, model = "WGS84")
    bottomRight <- gcDestination(lon = lon, lat = lat, bearing = 90, dist = distanceLon*2, dist.units = dist.unit, model = "WGS84")
    
    boxTopLeft <- gcDestination(lon = topLeft[1,"long"], lat = topLeft[1,"lat"], bearing = 315, dist = box.offset, dist.units = dist.unit, model = "WGS84")
    boxTopRight <- gcDestination(lon = bottomRight[1,"long"], lat = topLeft[1,"lat"], bearing = 45, dist = box.offset, dist.units = dist.unit, model = "WGS84")
    boxBottomRight <- gcDestination(lon = bottomRight[1,"long"], lat = bottomRight[1,"lat"], bearing = 135, dist = box.offset, dist.units = dist.unit, model = "WGS84")
    boxBottomLeft <- gcDestination(lon = topLeft[1,"long"], lat = bottomRight[1,"lat"], bearing = 225, dist = box.offset, dist.units = dist.unit, model = "WGS84")
    bg <- cbind(lon = c(boxTopLeft[1,"long"], boxTopRight[1,"long"], boxBottomRight[1,"long"], boxBottomLeft[1,"long"], boxTopLeft[1,"long"]),
                lat = c(boxTopLeft[1, "lat"], boxTopRight[1, "lat"], boxBottomRight[1, "lat"], boxBottomLeft[1, "lat"], boxTopLeft[1, "lat"]))
    bgdf <- data.frame(bg, stringsAsFactors = FALSE)
    bg <- geom_polygon(data = bgdf, aes(x = lon, y = lat), fill = box.fill.color, colour = box.line.color, size = 0.2)
    res <- c(res, bg)
  }
  
  laScaleBar <- createScaleBar(lon = lon, lat = lat, distanceLon = distanceLon, distanceLat = distanceLat, distanceLegend = distanceLegend, dist.unit = dist.unit)
  # First rectangle
  rectangle1 <- geom_polygon(data = laScaleBar$rectangle, aes(x = lon, y = lat), fill = rec.fill, colour = rec.colour)
  
  # Second rectangle
  rectangle2 <- geom_polygon(data = laScaleBar$rectangle2, aes(x = lon, y = lat), fill = rec2.fill, colour = rec2.colour)
  
  # Legend
  scaleBarLegend <- annotate("text", label = paste(laScaleBar$legend[,"text"], dist.unit, sep=""), x = laScaleBar$legend[,"long"], y = laScaleBar$legend[,"lat"], size = legend.size, colour = legend.colour)
  
  res <- c(res, list(rectangle1, rectangle2, scaleBarLegend))
  
  if(orientation){# Add an arrow pointing North
    coordsArrow <- createOrientationArrow(scaleBar = laScaleBar, length = arrow.length, distance = arrow.distance, dist.unit = dist.unit)
    arrow <- list(geom_segment(data = coordsArrow$res, aes(x = x, y = y, xend = xend, yend = yend), color = arrow.color), annotate("text", label = "N", x = coordsArrow$coordsN[1,"x"], y = coordsArrow$coordsN[1,"y"], size = arrow.North.size, colour = arrow.color))
    res <- c(res, arrow)
  }
  
  return(res)
}

#詳しい地図
# 地図データ
jp = rgdal::readOGR("~/Lab_Data/Japan_map_data/JPN_adm1.shp")
jp = fortify(jp) 

#表示したい範囲の緯度，経度（10進法表記）
longA = 128.89
longB = 129.33
latA = 32.80
latB = 33.31

#軸の区切り幅
dist_lat  = 0.2 
dist_long = 0.2  

#10進法表記から60進法表記への変換
dms = seq(latA-0.02, latB, by = dist_lat)
hms = seq(longA, longB, by = dist_long)
# dms = deg2dms(dms,　type = "cat", sep = "dms")　#データ数は軸の区切り位置とリンクしてる　
# hms = deg2hms(hms,　type = "cat", sep = "hms")

#ここは変換した緯度経度を見て自力で数値を入れる
dms[1] = expression("32.78"*degree)
dms[2] = expression("32.98"*degree)
dms[3] = expression("33.18"*degree)
# dms[c(2,4)] = ""  　#表示しない軸ラベル

hms[1] = expression("128.89"*degree)
hms[2] = expression("129.09"*degree)
hms[3] = expression("129.29"*degree)
# hms[c(1,3,5)] = ""　#表示しない軸ラベル

#plotする
xlabel = ""
ylabel = ""
kamigoto_map=ggplot() + 
  geom_polygon(aes(long, lat, group = group),
               data = jp,
               fill = "white",
               colour = "Black") + 
  coord_map(xlim = c(longA, longB), ylim = c(latA, latB)) +
  scale_y_continuous(breaks = seq(latA-0.02, latB, by = dist_lat), labels = c(dms))+
  scale_x_continuous(breaks = seq(longA, longB, by = dist_long), labels = c(hms))+
  labs(x = xlabel, y = ylabel)+
  annotate("text", x = 129.199219, y = 32.838058, label = "Nakadori Island", size = 7)+
  annotate("point", x = 129.110298, y = 32.951640, color = "red", size = 4)+
  annotate("point", x = 129.118195, y = 32.987644, color = "red", size = 4)+
  theme_bw()+
  theme(
    axis.text.y = element_text(angle = 35),
    axis.text.x = element_text(angle = 35, vjust = 1, hjust = 1),
    panel.border = element_rect(color = "black", fill = NA),
    panel.background = element_rect(fill = "grey90")
  )
```

```{r kamigoto-map, fig.cap = CAP}
CAP = "This study was conducted at Arikawa Bay (top disc) and Tainoura Bay (bottom disc) in Nakadori Island, Nagasaki Prefecture."
kamigoto_map
```

```{r setup-image, fig.cap = CAP}
CAP = "The setup of the data loggers used in this study."
knitr::include_graphics("~/Lab_Data/kawatea/Thesis_images/設置イメージ.png")
```

```{r temperature-plot, fig.cap = CAP}
CAP = "A boxplot of the mean daily water temperatures at Arikawa Bay and Tainoura Bay, Nakadori Island, Nagasaki Prefecutre. The black line indicates a Generalized Additive Model fit to the data, and the shaded region is the 95\\% confidence interval."
temperature_plot
```

```{r light-plot, fig.cap = CAP}
CAP = "A boxplot of the mean daily underwater photosynthetic photon flux density (PPFD) at Arikawa Bay and Tainoura Bay, Nakadori Island, Nagasaki Prefecutre. The black line indicates a Generalized Additive Model fit to the data, and the shaded region is the 95\\% confidence interval."
light_plot
```

```{r NEP-plot, fig.cap = CAP}
CAP = "A boxplot of the mean net ecosystem production rate (NEP) at Arikawa Bay and Tainoura Bay, Nakadori Island, Nagasaki Prefecutre. The black line indicates a Generalized Additive Model fit to the data, and the shaded region is the 95\\% confidence interval."
NEP_plot
```

```{r RP-plot, fig.cap = CAP}
CAP = "RP"
RP_plot
```

```{r cem-plot, fig.cap = CAP}
CAP = "The mean monthly water velocity at Arikawa Bay and Tainoura Bay, Nakadori Island, Nagasaki Prefecutre. The error bars indicate one standard error."
cem_plot
```

```{r nutrient-plot, fig.cap = CAP}
CAP = "The mean monthly nitrite-nitrate (top) and phosphate (bottom) concentration at Arikawa Bay and Tainoura Bay, Nakadori Island, Nagasaki Prefecutre. The error bars indicate one standard error."
nutrient_plot
```

# Tables

```{r temperature-table, results = "asis"}
CAP = "Monthly water temperatures at Arikawa Bay and Tainoura Bay, Nakadori Island, Nagasaki Prefecture."
CNAMES = c("Location", "Month", "Mean", "Std. Dev.", "Min.", "Max.")
temperature2 %>% 
  kable(format = "latex",
        booktabs = TRUE,
        linesep = "",
        caption = CAP,
        col.names = CNAMES,
        digits = c(0, 0, 1,1,1,1)) %>% 
  kable_styling(latex_options = "HOLD_position", 
                font_size = 10)

cat("\n\\clearpage\n")
```

```{r light-table, results = "asis"}
CAP = "Light"
CNAMES = c("Location", "Month", "Mean", "Std. Dev.", "Min.", "Max.")
light2 %>% 
  kable(format = "latex",
        booktabs = TRUE,
        linesep = "",
        caption = CAP,
        col.names = CNAMES,
        digits = c(0, 0, 1,1,1,1)) %>% 
  kable_styling(latex_options = "HOLD_position", 
                font_size = 10)

cat("\n\\clearpage\n")
```

```{r NEP-table, results = "asis"}
CAP = "NEP"
CNAMES = c("Location", "Month", "Mean", "Std. Dev.", "Min.", "Max.")
NEP2 %>% 
  kable(format = "latex",
        booktabs = TRUE,
        linesep = "",
        caption = CAP,
        col.names = CNAMES,
        digits = c(0, 0, 1,1,1,1)) %>% 
  kable_styling(latex_options = "HOLD_position", 
                font_size = 10)

cat("\n\\clearpage\n")
```

```{r RP-table, results = "asis"}
CAP = "RP"
CNAMES = c("Location", "Month", "Mean", "Std. Dev.", "Min.", "Max.")
RP2 %>% 
  kable(format = "latex",
        booktabs = TRUE,
        linesep = "",
        caption = CAP,
        col.names = CNAMES,
        digits = c(0, 0, 1,1,1,1)) %>% 
  kable_styling(latex_options = "HOLD_position", 
                font_size = 10)

cat("\n\\clearpage\n")
```


```{r gam-table, results = "asis"}
library(mgcv)
# Temperature
tmp1 = temperature %>% 
  gam(temperature ~ s(month, by = location)+location,
      family = Gamma(log), data = .) %>% 
  summary()
# Light
tmp2 = dset_daily %>% 
  gam(ppfd ~ s(month, by = location)+location,
      family = Gamma(log), data = .) %>% 
  summary()
# NEP
tmp3 = dset03 %>% 
  gam(value ~ s(month, by = location)+location,
      family = gaussian(), data = .) %>% 
  summary()
# ER
tmp4 = dset02 %>% 
  gam(value ~ s(month, by = location)+location,
      family = gaussian(), data = .) %>% 
  summary()

tmp1 = tmp1$s.table %>% as_tibble(rownames="Term")
tmp2 = tmp2$s.table %>% as_tibble(rownames="Term")
tmp3 = tmp3$s.table %>% as_tibble(rownames="Term")
tmp4 = tmp4$s.table %>% as_tibble(rownames="Term")

CAP = "Wald's test identifying the effect of the smoother for each location and measured variable."
CNAMES = c("Variable", "Location", "Est. D.F.", "Ref. D.F.", "\\textit{F}-value", "\\textit{P}-value")
bind_rows(tmp1, tmp2, tmp3, tmp4) %>% 
  mutate(Variable = rep(c("Water temperature","PPFD", "NEP", "ER"), each = 2)) %>% 
  mutate(Term = str_extract(Term, "Arikawa|Tainoura")) %>% 
  select(Variable, Term, edf, `Ref.df`, `F`, `p-value`) %>% 
    kable(format = "latex",
        booktabs = TRUE,
        linesep = "",
        caption = CAP,
        col.names = CNAMES,
        escape = FALSE,
        digits = c(0, 0, 1,1,1,1)) %>% 
  kable_styling(latex_options = "HOLD_position", 
                font_size = 10)

cat("\n\\clearpage\n")
```

```{r cem-table, results = "asis"}
# CAP = "cem"
# CNAMES = c("Location", "Month", "Mean", "Std. Dev.", "Min.", "Max.")
# cem2 %>% 
#   kable(format = "latex",
#         booktabs = TRUE,
#         linesep = "",
#         caption = CAP,
#         col.names = CNAMES,
#         digits = c(0, 0, 1,1,1,1)) %>% 
#   kable_styling(latex_options = "HOLD_position", 
#                 font_size = 10)
# 
# cat("\n\\clearpage\n")
```

```{r nutrient-table, results = "asis"}
# CAP = "nutrient"
# CNAMES = c("Location", "Month","Nutrient","Mean", "Std. Dev.", "Min.", "Max.")
# nutrient2 %>% 
#   kable(format = "latex",
#         booktabs = TRUE,
#         linesep = "",
#         caption = CAP,
#         col.names = CNAMES,
#         digits = c(0, 0, 0,1,1,1,1)) %>% 
#   kable_styling(latex_options = "HOLD_position", 
#                 font_size = 10)
# 
# cat("\n\\clearpage\n")
```